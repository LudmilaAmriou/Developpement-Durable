name: ðŸŒ±ðŸš€ðŸ’Ž Ã‰co-Coding - Tous Niveaux

on:
  push:
    paths:
      - "Exercices_Debutant/**"
      - "Exercices_Avance/**"
      - "Exercices_Expert/**"
  pull_request:
    paths:
      - "Exercices_Debutant/**"
      - "Exercices_Avance/**"
      - "Exercices_Expert/**"

permissions:
  contents: write

jobs:
  eco-coding:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # CHECKOUT
      # -----------------------------
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          ref: ${{ github.head_ref || github.ref_name || 'main' }}
          fetch-depth: 0 # Full history for pushing commits

      # -----------------------------
      # SETUP PYTHON
      # -----------------------------
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      # -----------------------------
      # DÃ‰BUTANT TESTS
      # -----------------------------
      - name: Tests DÃ©butant
        run: |
          echo "ðŸŒ± Running DÃ©butant tests..."
          python -m Exercices_Debutant.tests.test_judge
        continue-on-error: true

      # -----------------------------
      # AVANCÃ‰ TESTS
      # -----------------------------
      - name: Tests AvancÃ©
        run: |
          echo "ðŸš€ Running AvancÃ© tests..."
          python -m Exercices_Avance.tests.test_judge
        continue-on-error: true

      # -----------------------------
      # EXPERT TESTS
      # -----------------------------
      - name: Tests Expert
        run: |
          echo "ðŸ’Ž Running Expert tests..."
          python -m Exercices_Expert.tests.test_judge
        continue-on-error: true

      # -----------------------------
      # COMMIT REPORTS (FORCE)
      # -----------------------------

      - name: Commit all reports
        if: always()
        shell: bash
        run: |
          echo "ðŸ“¦ Preparing to commit reports..."

          git config --local user.email "action@github.com"
          git config --local user.name "Bot Ã‰co-Coding"

          # Use bash-friendly variable syntax
          CURRENT_BRANCH="${GITHUB_HEAD_REF:-${GITHUB_REF_NAME:-main}}"
          git fetch origin "$CURRENT_BRANCH"
          git checkout "$CURRENT_BRANCH"

          # Add report files if they exist
          if [ -f "ECO_REPORT_DEBUTANT.md" ]; then git add ECO_REPORT_DEBUTANT.md; fi
          if [ -f "ECO_REPORT_AVANCE.md" ]; then git add ECO_REPORT_AVANCE.md; fi
          if [ -f "ECO_REPORT_EXPERT.md" ]; then git add ECO_REPORT_EXPERT.md; fi

          # Commit only if changes exist
          if ! git diff --cached --quiet; then
            git commit -m "ðŸŒ±ðŸš€ðŸ’Ž Mise Ã  jour rapports Ã‰co-Coding [skip ci]"
            git push origin "$CURRENT_BRANCH"
          else
            echo "âœ… Reports are up-to-date, nothing to commit"
          fi
